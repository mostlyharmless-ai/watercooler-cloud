#!/usr/bin/env python3
"""Git credential helper for Watercooler.

This credential helper integrates with the watercooler-site dashboard to provide
seamless GitHub authentication for git operations.

When git needs credentials for HTTPS operations (clone, push, pull), it calls
this script which fetches the user's GitHub token from the dashboard API.

Usage:
    git config --global credential.helper watercooler

    Or configure automatically via MCP server environment:
    WATERCOOLER_DASHBOARD_URL=https://watercooler.example.com

Protocol:
    Git credential helpers use a simple text protocol via stdin/stdout.
    Input format:
        protocol=https
        host=github.com

    Output format:
        username=token
        password=<github-token>
"""

import os
import sys
import urllib.request
import urllib.error
import json


def get_dashboard_url() -> str:
    """Get dashboard URL from environment or use default."""
    return os.environ.get(
        "WATERCOOLER_DASHBOARD_URL",
        "https://watercooler-site-iu3swn55f-caleb-howards-projects.vercel.app"
    )


def parse_credential_input() -> dict[str, str]:
    """Parse git credential protocol input from stdin.

    Returns:
        Dictionary of key-value pairs from stdin
    """
    attrs = {}
    for line in sys.stdin:
        line = line.strip()
        if not line:
            break
        if "=" in line:
            key, value = line.split("=", 1)
            attrs[key] = value
    return attrs


def fetch_token_from_dashboard() -> str | None:
    """Fetch GitHub token from dashboard API.

    Returns:
        GitHub token string, or None if unavailable
    """
    dashboard_url = get_dashboard_url()
    api_url = f"{dashboard_url}/api/mcp/credentials"

    try:
        # Try to read session cookie from environment or git config
        # For now, we'll rely on the user having WATERCOOLER_GITHUB_TOKEN
        # as a fallback, and eventually support session-based auth
        token = os.environ.get("WATERCOOLER_GITHUB_TOKEN")
        if token:
            return token

        # Future: Make authenticated request to dashboard API
        # This would require:
        # 1. Session cookie from browser
        # 2. Or API key from dashboard settings
        # 3. Or OAuth device flow

        # For now, fall back to standard GitHub token env vars
        token = os.environ.get("GITHUB_TOKEN") or os.environ.get("GH_TOKEN")
        return token

    except Exception:
        return None


def main():
    """Main credential helper entry point."""
    if len(sys.argv) < 2:
        sys.stderr.write("Usage: git-credential-watercooler <get|store|erase>\n")
        sys.exit(1)

    action = sys.argv[1]

    if action == "get":
        # Parse input from git
        attrs = parse_credential_input()

        # Only handle github.com for now
        if attrs.get("host") != "github.com":
            sys.exit(0)

        # Fetch token from dashboard or environment
        token = fetch_token_from_dashboard()

        if token:
            # Output credentials in git protocol format
            print(f"username=token")
            print(f"password={token}")
        else:
            # No credentials available
            sys.exit(1)

    elif action == "store":
        # We don't store credentials (they come from dashboard)
        sys.exit(0)

    elif action == "erase":
        # We don't erase credentials (they're managed by dashboard)
        sys.exit(0)

    else:
        sys.stderr.write(f"Unknown action: {action}\n")
        sys.exit(1)


if __name__ == "__main__":
    main()
